import {
  Body,
  Delete,
  Get,
  Param,
  Patch,
  Post,
  Query,
  Res,
} from '@nestjs/common';
import { NotificationsService } from './notifications.service';
import { Response } from 'express';
import { CreateNotificationDto } from './dto/create-notification.dto';
import { UpdateNotificationDto } from './dto/update-notification.dto';
import { ControllerWrapper } from 'src/decorators/controller-wrapper.decorator';
import { CreateUpdateWrapper } from 'src/decorators/create-update-wrapper.decorator';
import { createNotificationBody } from './dto/create-notification.body';
import { updateNotificationBody } from './dto/update-notification.body';
import { MembersOnly } from 'src/decorators/members.decorator';
import { AdminsOnly } from 'src/decorators/admins.decorator';
import { GetAllWrapper } from 'src/decorators/get-all-wrapper.decorator';
import {
  GetConditionsProps,
  GetQueryProps,
} from 'src/types/get-operators.type';
import { AppService } from 'src/app.service';
import { NotificationFields } from 'src/enums/shared/tables-fields.enum';
import { ApiOperation } from '@nestjs/swagger';
import { CustomResponseType } from 'src/types/custom-response.type';
import { Notification } from './entities/notification.entity';
import { DeleteResult, UpdateResult } from 'typeorm';

@ControllerWrapper('notifications')
export class NotificationsController {
  constructor(
    private readonly notificationsService: NotificationsService,
    private readonly appService: AppService,
  ) {}

  @Get()
  @MembersOnly()
  @GetAllWrapper({
    fieldsEnum: NotificationFields,
  })
  async getNotifications(
    @Query()
    query: GetQueryProps<NotificationFields>,
    @Res() res: Response,
  ) {
    const { sortBy, reverse, page, conditions } = query;
    const parsed: GetConditionsProps<NotificationFields>[] =
      this.appService.validateGetConditions<NotificationFields>(conditions);

    const response: CustomResponseType<Notification[]> =
      await this.notificationsService.getNotifications({
        sortBy: sortBy || NotificationFields.CONTENT,
        reverse: reverse === 'true',
        page: Number(page),
        conditions: parsed || [],
      });
    return res.status(response.status).json(response);
  }

  @Get(':id')
  @MembersOnly()
  @ApiOperation({ summary: 'get a single exercise using its ID' })
  async getNotificationById(@Param('id') id: string, @Res() res: Response) {
    const response: CustomResponseType<Notification> =
      await this.notificationsService.getNotificationById(id);

    return res.status(response.status).json(response);
  }

  @Get('/user/:id')
  @MembersOnly()
  @ApiOperation({ summary: 'get all notifications that has the same user ID' })
  async getNotificationsByUserId(
    @Param('id') id: string,
    @Res() res: Response,
  ) {
    const response: CustomResponseType<Notification[]> =
      await this.notificationsService.getNotificationsByUserId(id);

    return res.status(response.status).json(response);
  }

  @Post()
  @MembersOnly()
  @CreateUpdateWrapper(
    CreateNotificationDto,
    createNotificationBody,
    'create a notification',
  )
  async createNotification(
    @Body() createNotificationDto: CreateNotificationDto,
    @Res() res: Response,
  ) {
    const response: CustomResponseType<Notification> =
      await this.notificationsService.createNotification(createNotificationDto);

    return res.status(response.status).json(response);
  }

  @Patch(':id')
  @MembersOnly()
  @CreateUpdateWrapper(
    UpdateNotificationDto,
    updateNotificationBody,
    'update a notification',
  )
  async updateNotification(
    @Param('id') id: string,
    @Body() updateNotificationDto: UpdateNotificationDto,
    @Res() res: Response,
  ) {
    const response: CustomResponseType<UpdateResult> =
      await this.notificationsService.updateNotification(
        id,
        updateNotificationDto,
      );

    return res.status(response.status).json(response);
  }

  @Patch('/toggle/:id')
  @MembersOnly()
  @ApiOperation({ summary: 'toggle the (isRead) flag  for a notification' })
  async toggleIsRead(@Param('id') id: string, @Res() res: Response) {
    const response: CustomResponseType<UpdateResult> =
      await this.notificationsService.toggleIsRead(id);

    return res.status(response.status).json(response);
  }

  @Delete('wipe')
  @AdminsOnly()
  @ApiOperation({ summary: 'delete all notifications' })
  async deleteAllNotifications(@Res() res: Response) {
    const response: CustomResponseType<DeleteResult> =
      await this.notificationsService.deleteAllNotifications();

    return res.status(response.status).json(response);
  }

  @Delete(':id')
  @MembersOnly()
  @ApiOperation({ summary: 'delete a notification' })
  async deleteNotification(@Param('id') id: string, @Res() res: Response) {
    const response: CustomResponseType<DeleteResult> =
      await this.notificationsService.deleteNotification(id);

    return res.status(response.status).json(response);
  }
}